20260213 작업 일지 - ControlNet 재학습 완료 및 모델 검증 계획 수립
================================================================================

1. 작업 목표
--------------------------------------------------------------------------------
20260212_2, 20260212_3에서 도출한 NaN Loss 수정 사항을 반영하여 Colab에서
재학습을 완료하였다. 재학습된 모델의 생성 품질을 다단계로 검증하는
계획을 수립하고, Colab에서 실행할 검증 스크립트를 구성한다.

2. 재학습 결과 분석
--------------------------------------------------------------------------------

2-1. 학습 환경
  - 실행 환경: Google Colab (GPU)
  - 데이터 경로: /content/drive/MyDrive/data/Severstal/controlnet_dataset
  - 출력 경로: /content/drive/MyDrive/data/Severstal/controlnet_training
  - 모델 저장: final_model/, pipeline/, best_model/ 모두 정상 저장

2-2. 학습 설정 (training_config.json)
  - Base Model: runwayml/stable-diffusion-v1-5
  - ControlNet 초기 가중치: lllyasviel/sd-controlnet-canny
  - Resolution: 512
  - Batch size: 1, Gradient accumulation: 4
  - Epochs: 100, Learning rate: 1e-5
  - LR Scheduler: constant_with_warmup
  - lr_warmup_steps: 50 (이전 500에서 수정됨)
  - Mixed precision: fp16
  - Gradient checkpointing: true

2-3. 이전 학습 vs 재학습 비교

  | 항목             | 이전 학습 (20260212)  | 재학습 (20260213)       |
  |-----------------|---------------------|------------------------|
  | Total Steps     | 200                 | 1,200                  |
  | Loss            | 전 구간 NaN          | 정상 수렴 (0.017~0.184) |
  | LR Warmup       | 500 (총 step 초과)   | 50 (step 50에서 목표 도달)|
  | Epochs 완주      | 100 (사실상 미학습)   | 100 (정상 완주)          |
  | NaN 발생         | 200/200 (100%)      | 0/120 (0%)             |

2-4. 학습 로그 상세 분석 (training_log.json)

  - Warmup 구간 (step 1-50):
    - LR: 2e-6 → 1e-5로 정상 증가
    - Loss: 0.048 ~ 0.081 범위
    - Warmup 완료 후 목표 LR(1e-5) 정상 도달 확인

  - 학습 안정기 (step 50-600):
    - Loss: 0.017 ~ 0.184 범위에서 진동
    - NaN 발생 없음
    - 명확한 수렴 추세보다는 진동 패턴 (소량 데이터 특성)

  - 후반부 (step 600-1200):
    - Loss가 소폭 감소 추세 (최저 0.0171 at step 590, 0.0179 at step 1100)
    - 최종 Loss: 0.030 (step 1200, epoch 99)

  - 주요 통계:
    - 총 Steps: 120 (logging_steps=10 기준, 실제 1,200 step)
    - Loss 평균: ~0.068
    - Loss 최저: 0.0171 (step 590)
    - Loss 최고: 0.1845 (step 670)
    - NaN 발생: 0건

2-5. 학습 결과 평가

  [긍정적]
  - NaN 문제 완전 해결: 20260212_3에서 적용한 4가지 수정 사항이 효과적이었음
    - Warmup steps 축소 (500 → 50)
    - Mixed precision autocast 3단 분리
    - NaN 처리 로직 개선
    - 1-step sanity check
  - 100 epoch 안정적 완주

  [우려 사항]
  - Loss 수렴 부족: 0.02~0.18 범위에서 진동 지속
    → 10개 샘플 극소량 학습의 구조적 한계
  - 과적합 가능성: 각 샘플을 약 480회 반복 학습
    → 학습 데이터에는 잘 맞지만 새 데이터에 대한 일반화 우려
  - 클래스 불균형: Class 1: 9개, Class 3: 1개
    → 20260212_3에서 stratified sampling 코드를 추가했으나,
       이번 학습에서는 기존 10개 데이터를 그대로 사용함

3. 모델 검증 계획 (4단계)
--------------------------------------------------------------------------------

검증은 Colab 환경에서 실행한다.
모델 파일(final_model/, pipeline/, best_model/)이 Google Drive에 위치하므로
Colab에서 직접 실행하는 것이 효율적이다.

3-1. Phase 1: 기본 생성 검증 (모델 작동 확인)

  - 목적: 학습된 모델이 의미 있는 이미지를 생성하는지 확인
  - 방법: 기존 scripts/test_controlnet.py 활용
  - 입력: train.jsonl의 10개 학습 데이터 hint 이미지
  - 출력: generated/ (생성 이미지), comparisons/ (비교 그리드)
  - 확인 사항:
    - 생성 이미지가 노이즈/빈 이미지가 아닌 금속 표면 결함 이미지인가
    - hint 이미지의 결함 위치/형태가 반영되는가
    - 비교 그리드(Hint | Generated | Original) 시각적 확인

  - 실행 명령:
    python scripts/test_controlnet.py \
        --pipeline_path /content/drive/MyDrive/data/Severstal/controlnet_training/pipeline \
        --jsonl_path /content/drive/MyDrive/data/Severstal/controlnet_dataset/train.jsonl \
        --output_dir /content/drive/MyDrive/data/Severstal/test_results/phase1_basic \
        --num_inference_steps 30 \
        --guidance_scale 7.5 \
        --seed 42

  - 실패 시: best_model로 교체하여 재시도
    --model_path /content/drive/MyDrive/data/Severstal/controlnet_training/best_model

3-2. Phase 2: 파라미터 탐색 (최적 설정 탐색)

  - 목적: guidance_scale, inference_steps 조합별 생성 품질 비교
  - 방법: 대표 hint 1개에 대해 다양한 파라미터로 반복 생성
  - 테스트 파라미터:

    | 파라미터            | 테스트 값             | 목적              |
    |--------------------|-----------------------|-------------------|
    | guidance_scale     | 3.0, 5.0, 7.5, 10.0  | conditioning 강도  |
    | num_inference_steps| 20, 30, 50            | 품질 vs 속도       |
    | seed               | 42, 123, 456, 789     | 다양성 확인        |

  - 생성 방식: 파라미터 조합당 4장씩 생성 (--num_images_per_sample 4)
  - 출력: test_results/phase2_gs{값}/, test_results/phase2_steps{값}/

3-3. Phase 3: 미학습 데이터 일반화 검증

  - 목적: 학습에 사용되지 않은 ROI로 모델의 일반화 능력 평가
  - 방법:
    1. roi_metadata.csv에서 학습 미사용 ROI 선별
       - 학습 사용 이미지: 0002cc93b.jpg, 0007a71bf.jpg, 000a4bcdd.jpg
       - 나머지 ROI에서 클래스별 상위 suitability_score 샘플 선택
    2. src/preprocessing/hint_generator.py로 새 hint 이미지 생성
    3. 생성된 hint로 ControlNet inference 실행
  - 출력: test_results/phase3_unseen/
  - 핵심 판단: 미학습 hint에도 합리적인 이미지가 생성되는가

3-4. Phase 4: 결과 종합 시각화 및 리포트

  - 학습 Loss 곡선 시각화 (training_log.json 기반)
    - Loss 추이 그래프 + 10-step 이동 평균
    - Loss 분포 히스토그램
  - 생성 결과 비교 그리드 종합
  - Phase 1~3 결과 요약 리포트

4. 판단 기준
--------------------------------------------------------------------------------

  | 평가 항목              | 통과 기준                               | 실패 시 조치                    |
  |----------------------|----------------------------------------|-------------------------------|
  | Phase 1 기본 생성      | 결함 형태가 hint에 대응하는 금속 표면 이미지 | best_model 시도 / 데이터 확대 재학습 |
  | Phase 2 파라미터 탐색   | gs 5~10 범위에서 안정적 생성              | 더 넓은 범위 탐색                |
  | Phase 3 일반화         | 미학습 hint에도 합리적인 이미지 생성        | 272개 전체 ROI로 확대 재학습       |
  | Phase 4 정량 점수      | QualityValidator 통과율 >= 70%          | 임계값 조정 또는 재학습            |

5. 예상 결과 및 후속 전략
--------------------------------------------------------------------------------

  - 10개 샘플 학습의 한계로 다음이 예상됨:
    - Phase 1 (학습 데이터): 과적합으로 비교적 잘 생성될 가능성 높음
    - Phase 3 (미학습 데이터): 일반화 부족으로 품질 저하 가능성 높음

  - Phase 3에서 일반화 부족이 확인되면:
    → 20260212_4.docs의 우선순위 기반 샘플 선별 전략 적용
    → 272개 전체 ROI 또는 고품질 ROI 선별 후 재학습
    → stratified sampling으로 클래스 균형 확보

6. 검증 실행에 필요한 작업
--------------------------------------------------------------------------------

  6-1. test_controlnet.py Colab 경로 호환성 확인
    - train.jsonl의 hint 경로: "data/processed/controlnet_dataset/hints/..."
    - Colab에서 실행 시 resolve_path()가 정상 동작하는지 확인
    - 필요 시 --image_root 파라미터로 경로 보완

  6-2. Phase 2용 배치 실행 스크립트 작성
    - scripts/run_validation_phases.py 또는 Colab 셀에서 직접 실행
    - 다양한 파라미터 조합을 반복 실행하는 루프

  6-3. Phase 3용 미학습 hint 생성 로직
    - roi_metadata.csv에서 미학습 ROI 필터링
    - HintGenerator를 활용한 새 hint 생성
    - 생성된 hint로 test_controlnet.py 실행

  6-4. Phase 4용 시각화
    - training_log.json 기반 loss 곡선 그래프
    - 전체 비교 그리드 종합 이미지

7. 변경/생성 파일
--------------------------------------------------------------------------------
  - docs/20260213.docs (본 문서, 신규 작성)

  [완료된 작업]
  - scripts/test_controlnet.py (수정)
    - resolve_path() 함수에 Colab 경로 호환성 강화
    - 하위 디렉토리(hints/, images/, masks/) 자동 탐색 추가
    - 경로의 suffix 부분 매칭 로직 추가
    
  - scripts/run_validation_phases.py (신규 작성)
    - Phase 1~4 통합 검증 배치 실행 스크립트
    - Phase 1: test_controlnet.py 호출로 학습 데이터 기본 생성 검증
    - Phase 2: guidance_scale(3.0/5.0/7.5/10.0), inference_steps(20/30/50),
               seed(42/123/456/789) 파라미터 조합 자동 반복 실행
    - Phase 3: roi_metadata.csv에서 미학습 ROI 클래스별 상위 suitability_score
               3개 자동 선별 → HintImageGenerator로 hint 생성 → inference 실행
    - Phase 4: training_log.json 기반 Loss 추이/이동평균/분포 시각화,
               Epoch별 평균 Loss 차트, Phase 1~3 종합 리포트 자동 생성
    - --phases 옵션으로 특정 Phase만 선택 실행 가능
