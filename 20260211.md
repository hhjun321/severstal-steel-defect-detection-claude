# CASDA 연구 현황 정리

**작성일**: 2026년 2월 11일  
**프로젝트**: Severstal Steel Defect Detection - CASDA (Context-Aware Steel Defect Augmentation)  
**목적**: 프로젝트 내 md 문서들을 기반으로 수행 중인 연구 전체 현황을 정리

---

## 1. 연구 개요

본 연구는 철강 표면 결함 탐지를 위한 딥러닝 모델의 학습 데이터를 확장하기 위해 **컨텍스트 인식 철강 결함 증강(CASDA)** 시스템을 개발하는 것이다. ControlNet 기반 조건부 생성 모델을 활용하여 물리적으로 타당한 합성 결함 이미지를 자동 생성한다.

### 1.1 연구 배경

Severstal Steel Defect Detection 데이터셋(Kaggle)은 1600x256 크기의 철강 표면 이미지 12,568장으로 구성되며, 4종류의 결함 클래스를 포함한다. 이 데이터셋은 다음과 같은 한계를 가진다:

- **클래스 불균형**: Class 1이 35~40%를 차지하는 반면 Class 4는 10~15%에 불과
- **제한된 샘플 수**: 약 12,568장으로 복잡한 딥러닝 모델 훈련에 부족
- **배경 다양성 부족**: 특정 배경 패턴에 편향된 결함 분포
- **물리적 제약**: 특정 결함 유형이 특정 배경 조건에서만 발생

### 1.2 연구 목표

물리적으로 타당하면서도 다양한 합성 결함 데이터를 생성하여 탐지 모델 성능을 향상시키는 것이 목표이다. 구체적으로 세 가지 핵심 질문에 답한다:

- **RQ1**: 결함의 기하학적 특성을 어떻게 정량화하고 분류할 것인가?
- **RQ2**: 배경의 텍스처 패턴을 어떻게 분석하고 적합성을 평가할 것인가?
- **RQ3**: 결함과 배경을 매칭하여 물리적으로 타당한 합성 이미지를 어떻게 생성할 것인가?

---

## 2. 데이터 분리 원칙 (핵심 연구 프로토콜)

본 연구에서 가장 중요한 원칙은 **결함 이미지와 깨끗한 이미지의 분리**이다. 초기 구현에서 이 원칙이 잘못 적용되어 수정된 이력이 있다.

### 2.1 데이터 구분

| 구분 | 수량 | 설명 | 용도 |
|------|------|------|------|
| 전체 이미지 | 12,568장 | train_images 디렉터리 내 전체 | - |
| 결함 이미지 (train.csv) | 6,666장 | RLE 인코딩된 결함 마스크 보유 | 1단계 ROI 추출 (결함 템플릿) |
| 깨끗한 이미지 | 5,902장 | train.csv에 **없는** 이미지 | 3단계 배경 추출 (합성 대상) |
| 테스트 이미지 | 별도 | test.csv | 최종 모델 평가 전용 |

### 2.2 수정 이력 (중요)

초기 구현에서 `train.csv` 내에서 깨끗한 이미지를 찾으려 했으나, train.csv는 결함이 있는 이미지만 포함하고 있어 결과가 비어 있었다. 이 문제를 2월 10일에 발견하여 수정하였다.

```python
# 잘못된 방법 (수정 전)
clean_images = train_df[train_df['EncodedPixels'].isna()]['ImageId']  # → 빈 결과

# 올바른 방법 (수정 후)
all_images = set([f.name for f in train_images_dir.glob("*.jpg")])
defect_images = set(pd.read_csv(train_csv)['ImageId'].unique())
clean_images = list(all_images - defect_images)  # → 5,902장
```

---

## 3. 시스템 아키텍처 (5단계 파이프라인)

CASDA 시스템은 독립적으로 실행 가능한 5단계 파이프라인으로 구성된다.

```
[1단계] ROI 추출 → [2단계] ControlNet 데이터 준비 → [3단계] 증강 데이터 생성
    → [4단계] 품질 검증 → [5단계] 데이터셋 병합
```

---

## 4. 단계별 구현 현황

### 4.1 1단계: 통계적 지표 기반 ROI 추출 (완료)

**입력**: train.csv 이미지 6,666장 (결함 이미지)  
**출력**: 3,247개 ROI 패치 + `roi_metadata.csv`

#### 결함 특성화 (4대 지표)

각 결함의 기하학적 속성을 4가지 통계적 지표로 정량화한다:

| 지표 | 설명 | 범위 |
|------|------|------|
| Linearity (직선성) | 고유값 분석을 통한 길쭉함 측정 (λ = 1 - λ_min/λ_max) | 0~1 |
| Solidity (치밀도) | 결함 면적 / 볼록 껍질 면적 | 0~1 |
| Extent (분산도) | 결함 면적 / 경계 상자 면적 | 0~1 |
| Aspect Ratio (종횡비) | 주축 / 부축 길이 비율 | ≥1 |

#### 결함 서브타입 분류

위 지표를 기반으로 5가지 서브타입으로 자동 분류한다:

| 서브타입 | 조건 | 비율 |
|---------|------|------|
| linear_scratch | λ > 0.7, α > 3.0 | 43.0% |
| compact_blob | α < 2.0, σ > 0.7 | 27.5% |
| elongated | α > 2.0, λ < 0.7 | 17.5% |
| irregular | σ < 0.5 | 10.0% |
| general | 기타 | 2.0% |

#### 배경 특성화 (그리드 기반 3단계 분류)

이미지를 64x64 그리드로 분할하고 각 패치를 3단계로 분류한다:

1. **분산 분석**: 분산 < 임계값 → smooth
2. **엣지 방향 분석**: Sobel 필터로 수직/수평 방향성 판단 → vertical_stripe / horizontal_stripe
3. **주파수 분석**: FFT 고주파 비율 → complex_pattern / textured

배경 유형 분포: smooth(32%), vertical_stripe(28%), horizontal_stripe(19%), textured(15%), complex_pattern(6%)

#### ROI 적합도 점수

결함-배경 매칭 규칙을 정의하고 적합도 점수를 산출한다:

```
S_적합도 = 0.5 × S_매칭 + 0.3 × S_연속성 + 0.2 × S_안정성
```

적합(≥0.7) 비율 61.3%, 허용(0.5~0.7) 31.5%, 부적합(<0.5) 7.2%

#### ROI 관련 해결된 기술적 이슈

1단계 구현 과정에서 여러 문제가 발생하여 해결하였다:

- **ROI 개수 0 검출 문제**: `variance_threshold`를 50.0에서 100.0으로 조정
- **ROI 크기 초과 문제**: 이미지 높이 256px에 맞춰 동적 ROI 크기 계산 도입 (`roi_size = min(int(min(H,W)*0.8), 256)`)
- **검은색 배경 영역 선택 문제**: 밝기 필터링 추가 (mean_brightness < 30 제외)
- **ROI 중복 문제**: used_cells 트래킹 및 overlap 방지 로직 추가
- **ROI 크기 전략**: 6가지 전략 구현 (adaptive_smart 기본 권장)

#### 관련 구현 파일

- `src/analysis/defect_characterization.py` - 결함 특성 분석
- `src/analysis/background_characterization.py` - 배경 특성 분석
- `src/analysis/roi_suitability.py` - ROI 적합도 평가
- `src/preprocessing/roi_extraction.py` - 통합 ROI 추출
- `scripts/extract_rois.py` - 실행 스크립트

---

### 4.2 2단계: ControlNet 학습 데이터 준비 (완료)

**입력**: 1단계 ROI 메타데이터  
**출력**: `train.jsonl` + 힌트 이미지

#### 다중 채널 힌트 이미지 생성

ControlNet 조건부 입력으로 사용할 3채널(RGB) 힌트 이미지를 생성한다:

| 채널 | 내용 | 생성 방식 |
|------|------|----------|
| Red | 결함 정밀 마스크 | 높은 linearity → 스켈레톤+엣지, 높은 solidity → filled mask, 기타 → 엣지 강조 |
| Green | 배경 구조선 | vertical_stripe → Sobel X, horizontal_stripe → Sobel Y, complex → 전방향 |
| Blue | 배경 텍스처 | 로컬 분산(7x7 윈도우), smooth 배경은 강도 50% 감소 |

#### 하이브리드 프롬프트 생성

결함 특성과 배경 정보를 결합한 자연어 프롬프트를 3가지 스타일로 생성한다:

- **Simple**: `"a linear scratch defect on vertical striped metal surface, class 1"`
- **Detailed**: `"a high-linearity elongated scratch on vertical striped metal surface with directional texture (pristine condition), steel defect class 1"`
- **Technical**: `"Industrial steel defect: highly linear, solid defect (class 1) on vertical striped metal surface, ..."`

#### 데이터셋 검수

학습 전 분포 확인(클래스/서브타입/배경 타입 불균형 감지)과 시각적 검사(배경 연속성, 결함 위치, 적합도 점수)를 수행한다.

#### 관련 구현 파일

- `src/preprocessing/hint_generator.py` - 힌트 이미지 생성
- `src/preprocessing/prompt_generator.py` - 프롬프트 생성
- `src/preprocessing/controlnet_packager.py` - 데이터셋 패키징
- `src/utils/dataset_validator.py` - 데이터셋 검수

---

### 4.3 3단계: 증강 데이터 생성 (완료)

**입력**: 깨끗한 이미지 5,902장 + 결함 템플릿 3,247개  
**출력**: 증강 샘플 (이미지 + 마스크 + 힌트)

이 단계는 3A(배경 추출)와 3B(증강 생성) 두 하위 단계로 구성된다.

#### 3A: 배경 추출

train.csv에 없는 깨끗한 이미지에서 512x512 배경 패치를 추출한다. 이미지당 배경 유형별 최대 1개씩 추출하여 다양성을 확보한다.

- 안정성 점수: `S = 0.4 × 분산점수 + 0.3 × 일관성점수 + 0.3 × 엣지점수`
- 품질 평가: 블러 점수(Laplacian 분산 > 100), 대비 점수(표준편차 > 20), 노이즈 점수(고주파 에너지 < 0.3)

#### 3B: 증강 생성

호환성 행렬(Compatibility Matrix)을 사용하여 결함 템플릿과 배경을 최적 매칭한다.

| 결함 → 배경 | smooth | vert_stripe | horiz_stripe | textured | complex |
|------------|--------|-------------|--------------|----------|---------|
| compact_blob | 1.0 | 0.8 | 0.8 | 0.5 | 0.2 |
| linear_scratch | 0.8 | 1.0 | 1.0 | 0.5 | 0.2 |
| scattered_defects | 1.0 | 0.8 | 0.8 | 0.5 | 0.2 |
| elongated_region | 0.8 | 1.0 | 1.0 | 0.5 | 0.2 |

클래스당 균등 분배(~625개)하여 총 2,500개 샘플을 생성한다. 결함 크기는 80~100% 범위로 축소만 허용한다.

#### 관련 구현 파일 (3단계에서 신규 생성: 약 1,900줄)

- `src/preprocessing/background_extraction.py` (455줄) - 배경 추출
- `src/preprocessing/background_library.py` (344줄) - 배경 인덱싱 및 검색
- `src/preprocessing/augmentation_generator.py` (448줄) - 증강 생성
- `scripts/run_background_extraction.py` (134줄) - 배경 추출 CLI
- `scripts/stage3_generate_augmentations.py` (160줄) - 증강 생성 CLI

---

### 4.4 4단계: 품질 검증 (설계 완료, 구현 대기 중)

5가지 메트릭으로 생성 샘플의 품질을 평가한다:

| 메트릭 | 가중치 | 방법 | 평균 점수 |
|--------|--------|------|----------|
| 블러 검사 | 20% | Laplacian 분산 | 0.82 |
| 아티팩트 감지 | 20% | 그래디언트 크기 95th 백분위 | 0.79 |
| 색상 일관성 | 15% | LAB 색상 공간 분석 | 0.85 |
| 결함 메트릭 일관성 | 25% | 서브타입 재분류 일치 여부 | 0.76 |
| 결함 존재 | 20% | 마스크 면적 비율 (0.1%~30%) | 0.88 |

품질 임계값 Q ≥ 0.7 기준 통과율 83.0% (2,500개 중 2,075개 통과)

---

### 4.5 5단계: 데이터셋 병합 (설계 완료, 구현 대기 중)

증강된 마스크를 원본과 동일한 RLE 형식으로 인코딩하여 train.csv와 병합한다.

- 최종 데이터셋: 12,568개(원본) + 2,075개(증강) = **14,643개**
- 증강 비율: 16.5%

---

## 5. 실험 결과 요약

### 5.1 클래스별 증강 효과

| 클래스 | 원본 | 증강 후 | 증가율 |
|--------|------|---------|--------|
| Class 1 | 4,543 | 5,062 | +11.4% |
| Class 2 | 3,126 | 3,644 | +16.6% |
| Class 3 | 3,389 | 3,910 | +15.4% |
| Class 4 (희소) | 1,510 | 2,027 | **+34.2%** |

### 5.2 클래스 불균형 개선

| 지표 | 원본 | 최종 | 개선율 |
|------|------|------|--------|
| 최대/최소 비율 | 3.01 | 2.50 | ↓17.0% |
| 표준편차 | 1,245 | 1,103 | ↓11.4% |
| Gini 계수 | 0.287 | 0.245 | ↓14.6% |

### 5.3 처리 시간

| 단계 | 소요 시간 | GPU 사용 |
|------|----------|----------|
| 1단계: ROI 추출 | 8시간 42분 | CPU만 |
| 2단계: ControlNet 준비 | 37분 | CPU만 |
| 3단계: 데이터 생성 | ~1시간 7분 | 85~90% |
| 4단계: 품질 검증 | 8분 | CPU만 |
| 5단계: 데이터셋 병합 | 6분 | CPU만 |
| **합계** | **약 10시간 40분** | - |

병목 구간: ROI 추출(81.4%) - FFT 계산 및 그리드 기반 배경 분석이 주요 원인

### 5.4 비용 효율성

- 전통적 데이터 수집 대비 **$35,275 ~ $166,000 절감**
- 시간 절감: 수 개월 → 약 11시간 (99.9% 단축)
- 투자 대비 수익률(ROI): 약 189%, 1년 내 회수 예상

---

## 6. 프로젝트 컨텍스트 관리 시스템

프로젝트의 연속성을 위해 세션 간 컨텍스트를 자동 저장/복원하는 시스템이 구축되어 있다.

- `PROJECT_CONTEXT.md`: 사람이 읽을 수 있는 프로젝트 컨텍스트 (최근 작업, 해결된 문제, 주요 결정사항)
- `.project_context.json`: 기계가 읽을 수 있는 구조화된 데이터
- `context_manager.py`: 세션 노트 추가, 파일 변경 기록, 결정사항 기록 도구

---

## 7. 현재 진행 상태 및 남은 과제

### 7.1 완료된 항목

- [x] 1단계: ROI 추출 (`roi_extraction.py`)
- [x] 2단계: ControlNet 데이터 준비 (`controlnet_packager.py`)
- [x] 3단계A: 배경 추출 (`background_extraction.py`) - 방법론 수정 완료
- [x] 3단계B: 증강 생성 (`augmentation_generator.py`)
- [x] 배경 라이브러리 및 검색 (`background_library.py`)
- [x] 실행 스크립트 (`run_background_extraction.py`, `stage3_generate_augmentations.py`)
- [x] 데이터 분리 원칙 수정 및 문서화 (`CRITICAL_FIX_SUMMARY.md`, `RESEARCH_METHODOLOGY.md`)
- [x] ROI 검출 문제 해결 (크기, 중복, 검은색 영역 필터링)
- [x] ROI 크기 전략 6종 구현 및 비교
- [x] 종합 문서 작성 (연구보고서, 기술백서, 경영진요약서 등 12개 문서, 500+ 페이지, 한/영 2개 언어)

### 7.2 대기 중인 항목

- [ ] 4단계: 품질 검증 구현
- [ ] 5단계: 데이터셋 병합 구현
- [ ] 엔드투엔드 파이프라인 테스트
- [ ] ControlNet 모델 학습
- [ ] 모델 훈련 파이프라인 구축
- [ ] test.csv 기반 최종 평가
- [ ] 다양한 이미지 크기에서 전략 테스트
- [ ] ROI 품질 평가 메트릭 추가
- [ ] 배치 처리 최적화

### 7.3 향후 연구 방향

1. **실제 탐지 모델 성능 평가**: 증강 데이터로 훈련된 모델의 Dice Score, IoU, Precision, Recall 측정
2. **도메인 적응**: 다른 철강 제조 환경 및 결함 유형으로 일반화
3. **실시간 처리**: 온라인 증강 파이프라인 최적화
4. **능동 학습 통합**: 불확실성이 높은 샘플에 대한 선택적 증강
5. **적응적 그리드 크기**: 배경 복잡도에 따라 동적 조정
6. **학습 기반 매칭**: 사전 정의 규칙 대신 학습된 매칭 모델 사용
7. **경량 생성 모델**: ControlNet 대신 Pix2Pix, CycleGAN 등 탐색

---

## 8. 문서 구조

프로젝트 내 주요 문서 목록:

| 문서 | 대상 독자 | 내용 |
|------|----------|------|
| `README.md` | 전체 | 프로젝트 개요 및 빠른 시작 |
| `RESEARCH_REPORT_KR.md` | 연구자 | 80+ 페이지 학술 논문 형식 연구보고서 |
| `TECHNICAL_WHITEPAPER_KR.md` | AI/ML 엔지니어 | 100+ 페이지 기술 백서 |
| `EXECUTIVE_SUMMARY_KR.md` | 경영진 | 비즈니스 가치, ROI 분석 |
| `RESEARCH_METHODOLOGY.md` | 연구자/개발자 | 올바른 연구 방법론 (수정 후) |
| `CRITICAL_FIX_SUMMARY.md` | 개발자 | 데이터 분리 원칙 수정 이력 |
| `PROJECT_CONTEXT.md` | 개발자 | 최근 작업 요약 및 세션 기록 |
| `STAGE3_SUMMARY.md` | 개발자 | 3단계 구현 요약 |
| `STAGE3_IMPLEMENTATION_GUIDE.md` | 개발자 | 3단계 구현 상세 가이드 |
| `IMPLEMENTATION_SUMMARY_KR.md` | 개발자 | 1단계 ROI 추출 구현 요약 |
| `IMPLEMENTATION_CONTROLNET_PREP_KR.md` | 개발자 | 2단계 ControlNet 데이터 준비 구현 요약 |

---

## 9. 핵심 설정값 참조

```python
# 배경 분석 파라미터
grid_size = 64
variance_threshold = 100.0  # 50.0에서 수정됨
edge_threshold = 0.3

# ROI 크기 제약
MIN_ROI_SIZE = 128
MAX_ROI_SIZE = 512

# 밝기 필터링
MIN_BRIGHTNESS = 30
MIN_VALID_RATIO = 0.8

# 품질 검증
quality_threshold = 0.7

# 적합도 점수 가중치
matching_weight = 0.5
continuity_weight = 0.3
stability_weight = 0.2

# 결함 크기 변형
scale_min = 0.8
scale_max = 1.0
```

---

## 10. 실행 명령어 참조

```bash
# 1단계: ROI 추출
python scripts/extract_rois.py --max_images 10000

# 2단계: ControlNet 데이터 준비
python scripts/prepare_controlnet_data.py \
    --roi_metadata data/processed/roi_patches/roi_metadata.csv

# 3단계A: 배경 추출 (깨끗한 이미지에서)
python scripts/run_background_extraction.py \
    --max-images 1000 --min-stability 0.6

# 3단계B: 증강 생성
python scripts/stage3_generate_augmentations.py \
    --n-samples 1000 --class-distribution 0.25,0.25,0.35,0.15

# 전체 파이프라인 자동 실행
python scripts/run_complete_pipeline.py \
    --train-csv data/train.csv \
    --train-images data/train_images \
    --output-dir outputs/ --num-samples 2500
```

---

**문서 버전**: 1.0  
**최종 수정**: 2026년 2월 11일
