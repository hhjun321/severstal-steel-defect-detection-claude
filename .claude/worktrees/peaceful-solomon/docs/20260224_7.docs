20260224 작업 일지 #7 - YOLO 데이터셋 검증 스크립트 (verify_yolo_dataset.py)
================================================================================

1. 작업 목표
--------------------------------------------------------------------------------
사전 변환된 YOLO 데이터셋(images/, labels/, dataset.yaml)이 원본 CSV 대비
정상적으로 결함 bbox를 포함하는지 3단계로 검증하는 독립 스크립트 작성.

검증 목적:
  - YOLO 변환 파이프라인(dataset_yolo.py)의 정확성 확인
  - 라벨 파일 누락·손상·좌표 이상 조기 발견
  - 원본 CSV RLE와의 bbox 1:1 대응 여부 정량적 확인
  - 시각적 overlay로 인간이 직접 눈으로 확인 가능


2. 변경 파일
================================================================================

  | 파일                                   | 상태 | 라인수 | 변경 내용                              |
  |----------------------------------------|------|--------|----------------------------------------|
  | scripts/verify_yolo_dataset.py         | 신규 | 310    | YOLO 데이터셋 3단계 검증 스크립트       |


3. 주요 변경 내용
================================================================================

3.1 전체 구조
--------------
3개의 독립 검증 단계로 구성. 각 단계는 이전 단계 결과를 활용하되 개별 실행 가능.

  main()
    ├── Step 1: print_dataset_stats()      → 통계 분석 (콘솔 출력)
    ├── Step 2: cross_check_with_csv()     → CSV RLE 재계산 비교 (콘솔 출력)
    └── Step 3: visualize_samples()        → 시각화 PNG 저장


3.2 Step 1: 통계 분석 — print_dataset_stats() (L96-130)
---------------------------------------------------------
지정 split(train/val/test) 전체 이미지에 대해 라벨 파일을 파싱하여 통계 산출.

  검증 항목:
    - 이미지 파일 수 vs 라벨 파일 수
    - 빈 라벨(결함 없음) 비율
    - 클래스별 bbox 개수 분포 (Class0~Class3)
    - 좌표 범위 위반: cx, cy ∈ [0,1], w, h ∈ (0,1] 이탈 건수
    - 클래스 ID 위반: 0~3 범위 외 건수

  출력 예시:
    ==========================================================
      YOLO Dataset Statistics: baseline_raw/train
    ==========================================================
      Images: 4666,  Label files: 4666
      Empty labels (no defects): 0 (0.0%)
      Total bboxes: 5989
      Class distribution:
        Class0 (Class1): 234 bboxes
        Class1 (Class2): 312 bboxes
        Class2 (Class3): 4876 bboxes
        Class3 (Class4): 567 bboxes
      Coord range violations (outside 0~1): 0 / 5989
      Class ID violations (outside 0~3):    0 / 5989

  보조 함수:
    parse_label_file(label_path) — .txt 한 줄씩 파싱하여
      list of (class_id, cx, cy, w, h) 반환. 빈 파일이면 빈 리스트.


3.3 Step 2: CSV Cross-check — cross_check_with_csv() (L137-195)
------------------------------------------------------------------
원본 train.csv에서 RLE → bbox를 재계산하여 YOLO .txt 라벨과 1:1 비교.

  동작 흐름:
    1) train.csv 로드, ImageId_ClassId 컬럼 분리, ClassId 0-indexed 변환
    2) 결함 행(EncodedPixels notna)마다 rle_to_bboxes() 호출 → 재계산
    3) split 이미지 중 원본(casda_ 접두사 제외)만 대상
    4) 이미지별 비교:
       a) bbox 개수 일치 여부
       b) 개수 일치 시 좌표 근사 매칭 (tolerance=0.01 ≈ ±16px@1600w)
    5) 불일치 사례 상세 출력 (최대 10건)

  rle_to_bboxes() (L136-152):
    dataset_yolo.py의 _rle_to_bboxes()와 동일 로직 재구현.
    rle_decode() → cv2.findContours() → cv2.boundingRect() → normalize.
    16px² 미만 아티팩트 필터링 포함.

  _match_bboxes() (L198-216):
    두 bbox 리스트의 순서 무관 greedy 매칭.
    class_id 일치 + 4좌표 모두 tolerance 내이면 매칭 성공.

  출력 예시:
    ==========================================================
      CSV Cross-check (4666 images)
    ==========================================================
      Exact match:         4650 / 4666 (99.7%)
      Bbox count mismatch: 16
      Coord mismatch:      0

  참고: bbox 개수 차이는 16px² 미만 아티팩트 필터링 때문에 발생 가능.
  이는 정상적인 동작이며, 의미 있는 결함 bbox가 누락된 것은 아님.


3.4 Step 3: 시각화 — visualize_samples() (L222-276)
------------------------------------------------------
샘플 이미지에 YOLO bbox와 CSV 재계산 bbox를 동시에 그려 PNG로 저장.

  시각화 규칙:
    - YOLO bbox: 클래스별 색상 실선 (2px), 상단에 "YOLO Class1" 텍스트
    - CSV bbox:  빨강 점선 (1px), 하단에 "CSV Class1" 텍스트
    - 좌상단에 이미지 정보 (파일명, YOLO bbox 수, CSV bbox 수)

  클래스별 색상 (BGR):
    Class0 (Class1): (255, 100, 100)  파랑
    Class1 (Class2): (100, 200, 100)  초록
    Class2 (Class3): (0, 220, 255)    노랑
    Class3 (Class4): (80, 80, 255)    빨강

  샘플링 전략:
    1) 결함 있는 이미지 우선 (셔플, seed=42)
    2) 부족하면 빈 이미지에서 채움
    → 결함 bbox가 있는 이미지를 반드시 포함하여 시각적 검증 보장

  _draw_dashed_rect() (L279-295):
    OpenCV에 점선 사각형 그리기. 4변 각각 dash_len 간격으로 세그먼트 반복.

  출력:
    {output-dir}/{split}/{stem}_verify.png
    예: yolo_verify/train/abc123_verify.png


3.5 CLI 인자 — main() (L301-310)
-----------------------------------

  | 인자           | 필수 | 기본값             | 설명                              |
  |---------------|------|--------------------|-----------------------------------|
  | --yolo-dir    | ○    | —                  | YOLO 데이터셋 상위 디렉토리        |
  | --group       | ×    | baseline_raw       | 그룹명                             |
  | --csv         | ×    | None               | 원본 train.csv (없으면 cross-check 생략) |
  | --output-dir  | ×    | outputs/yolo_verify| 시각화 PNG 저장 위치               |
  | --num-samples | ×    | 20                 | 시각화 샘플 수                     |
  | --split       | ×    | train              | 검증 대상 split (train/val/test)   |


4. 사용 흐름
================================================================================

4.1 Colab 전체 검증 (권장)
----------------------------
  python /content/severstal-steel-defect-detection/scripts/verify_yolo_dataset.py \
      --yolo-dir /content/yolo_datasets \
      --group baseline_raw \
      --csv /content/drive/MyDrive/data/Severstal/train.csv \
      --output-dir /content/drive/MyDrive/data/Severstal/casda/yolo_verify \
      --num-samples 20 \
      --split train

  → 콘솔: 통계 + cross-check 결과
  → PNG: yolo_verify/train/ 에 20장 저장

4.2 CSV 없이 통계+시각화만
-----------------------------
  python scripts/verify_yolo_dataset.py \
      --yolo-dir /content/yolo_datasets \
      --group baseline_raw \
      --output-dir /content/yolo_verify \
      --split val

  → cross-check 단계 건너뜀, 통계 + 시각화만 수행

4.3 val/test split 검증
--------------------------
  python scripts/verify_yolo_dataset.py \
      --yolo-dir /content/yolo_datasets \
      --group baseline_raw \
      --csv /content/drive/MyDrive/data/Severstal/train.csv \
      --split val --num-samples 10


5. 정상/비정상 판단 기준
================================================================================

  | 항목                        | 정상                         | 비정상 (조치 필요)              |
  |-----------------------------|------------------------------|--------------------------------|
  | 빈 라벨 비율                | 0% (결함 이미지만 사용)       | >5% → 이미지 ID 매칭 오류 의심  |
  | 좌표 범위 위반              | 0건                          | 1건 이상 → normalize 버그       |
  | 클래스 ID 위반              | 0건                          | 1건 이상 → 0-indexed 변환 버그  |
  | CSV cross-check 일치율      | >99%                         | <95% → 변환 로직 버그           |
  | bbox 개수 차이 원인         | 16px² 미만 아티팩트 필터링    | 대량 차이 → contour 로직 오류   |
  | 시각화: YOLO(초록)=CSV(빨강)| 완전 겹침                     | 위치 불일치 → 좌표계 오류       |


6. 구문 검증
================================================================================
  python -c "import ast; ast.parse(open('scripts/verify_yolo_dataset.py', encoding='utf-8').read())"
  → Syntax OK
