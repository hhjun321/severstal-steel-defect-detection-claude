20260221 작업 일지 - v4 ControlNet 검증 결과 분석
================================================================================

1. 분석 목표
--------------------------------------------------------------------------------
outputs/test_results_v4/ 디렉토리에 저장된 v4 ControlNet 모델의 4단계
검증(validation) 결과를 종합 분석하고, v1 학습과의 비교를 통해
현재 모델 상태를 평가한다.


2. 검증 단계별 결과 요약
================================================================================

  | 단계                    | 상태       | 비고                                    |
  |-------------------------|------------|-----------------------------------------|
  | Phase 1 (기본 생성)     | 미실행     | validation_report.txt에 "Not executed"   |
  | Phase 2 (파라미터 스윕) | PASS       | 11개 조합 테스트, 정량 지표 없음 (시각적)|
  | Phase 3 (미지 데이터)   | PASS       | 12개 샘플, 평균 품질 0.6633              |
  | Phase 4 (학습 통계)     | PASS       | 578 steps, 24 epochs, 최종 loss 0.2245  |

  validation_results.json에서 Phase 1 = false로 기록되어 있으나,
  이는 "실패"가 아니라 "미실행"으로 인한 기본값이다.
  validation_report.txt에 "Phase 1: Not executed"로 명시되어 있음.


3. Phase 1 분석 - 기본 생성 품질
================================================================================

3-1. 현황

  phase1_basic/generated/ 디렉토리에 250개의 생성 이미지가 존재한다.
  phase1_basic/comparisons/ 디렉토리에 250개의 비교 이미지가 존재한다.
  그러나 정량적 메트릭(SSIM, LPIPS 등)을 산출하는 공식 검증은 실행되지 않았다.

  이미지는 존재하지만 검증 파이프라인이 정식으로 실행되지 않은 상태로,
  별도 실행이나 부분 실행으로 생성된 것으로 추정된다.

3-2. 클래스별 분포

  | 클래스  | 생성 이미지 수 | 비율   |
  |---------|----------------|--------|
  | Class 1 | 217            | 86.8%  |
  | Class 2 | 33             | 13.2%  |
  | Class 3 | 0              | 0.0%   |
  | Class 4 | 0              | 0.0%   |
  | 합계    | 250            | 100%   |

3-3. 문제점

  (1) Class 3, Class 4의 생성 이미지가 전혀 없음
      → Severstal 원본 데이터셋의 클래스 불균형이 그대로 반영된 결과
      → 벤치마크 실험에서 소수 클래스 증강 효과를 입증하려면
        Class 3/4에 대한 오버샘플링 전략이 필수

  (2) 정량적 메트릭 부재
      → Phase 1 공식 실행 시 SSIM, LPIPS 등의 지표가 산출되어야 함
      → 현재는 시각적 비교만 가능한 상태


4. Phase 2 분석 - 파라미터 스윕
================================================================================

4-1. 테스트 구성

  단일 이미지(6b634bbe9.jpg_class1_region2)에 대해 11개 조합을 테스트:

  | 파라미터          | 테스트 값               | 샘플 수      |
  |-------------------|-------------------------|--------------|
  | Guidance Scale    | 3.0, 5.0, 7.5, 10.0    | 각 4개 (16)  |
  | Inference Steps   | 20, 30, 50              | 각 4개 (12)  |
  | Seed              | 42, 123, 456, 789       | 각 1개 (4)   |

4-2. 한계

  - 정량적 메트릭(SSIM, FID 등)이 산출되지 않음
  - PNG 이미지만 존재하여 시각적 비교만 가능
  - 단일 이미지에 대한 테스트이므로 일반화에 한계가 있음
  - 최적 파라미터 조합을 객관적으로 결정하기 어려운 상태


5. Phase 3 분석 - 미지 데이터 일반화
================================================================================

5-1. 테스트 구성

  학습에 사용되지 않은 12개 샘플로 일반화 능력을 테스트:
  - Class 1: 3개 (9d57d9095, c22accc84, 8f8a23f39)
  - Class 2: 3개 (3fe32ff2f, 8b9c035ec, 68cc04a14)
  - Class 3: 3개 (5fa81f2b5, e8fefd824, 09e15218c)
  - Class 4: 3개 (f41732c94, 374d9c63f, f4495532f)

  생성 파라미터: inference_steps=30, guidance_scale=7.5, seed=42

5-2. 품질 점수 요약

  | 지표               | 값     |
  |--------------------|--------|
  | 평균 품질 점수     | 0.6633 |
  | 색상 일관성        | 0.9083 |
  | 아티팩트 점수      | 0.0000 |
  | 선명도 점수        | 1.0000 |
  | 평가 이미지 수     | 12     |
  | 품질 통과 여부     | PASS   |

5-3. 개별 샘플 점수

  | 파일명                              | 품질  | 색상 | 아티팩트 | 선명도 |
  |-------------------------------------|-------|------|----------|--------|
  | 09e15218c_class3_region1_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | 374d9c63f_class4_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | 3fe32ff2f_class2_region1_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | 5fa81f2b5_class3_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | 68cc04a14_class2_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | 8b9c035ec_class2_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | 8f8a23f39_class1_region1_gen0.png   | 0.70  | 1.0  | 0.0      | 1.0    |
  | 9d57d9095_class1_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | c22accc84_class1_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | e8fefd824_class3_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | f41732c94_class4_region1_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |
  | f4495532f_class4_region0_gen0.png   | 0.66  | 0.9  | 0.0      | 1.0    |

5-4. 분석

  긍정적 측면:
  - 4개 클래스 전체에서 생성 성공 (class3/4 포함)
  - 아티팩트 0.0: v4의 grayscale 관련 개선(A1, B1, B2)이 효과적으로 작동
  - 선명도 1.0: 생성 이미지의 흐림 문제 없음
  - 색상 일관성 0.9: RGB 채널 간 일관성이 높음 (완벽한 1.0은 아님)

  우려 사항:
  - 점수 분산이 극히 낮음 (12개 중 11개가 동일한 0.66)
  - 8f8a23f39만 0.70으로 유일한 이탈값
  - 이 좁은 분산은 품질 메트릭의 변별력이 부족할 가능성을 시사
  - 3개 하위 지표(색상/아티팩트/선명도)만으로는 결함 형태의 정확도,
    텍스처 유사도, 구조적 일치도 등을 평가하기 어려움
  - SSIM, LPIPS 등 지각적 유사도 메트릭 추가 필요


6. Phase 4 분석 - v1 vs v4 학습 비교
================================================================================

6-1. 학습 통계 비교

  | 지표           | v1                    | v4                    | 비율      |
  |----------------|-----------------------|-----------------------|-----------|
  | 총 에포크      | 100 (완주)            | 24 (조기 종료)        | v4 = 24%  |
  | 총 스텝        | 1,200                 | 578                   | v4 = 48%  |
  | 평균 loss      | 0.0700                | 0.2371                | v4 = 3.4x |
  | 중앙값 loss    | 0.0642                | 0.2342                | v4 = 3.6x |
  | 최소 loss      | 0.0094 (step 130)     | 0.1768 (step 4280)    | v4 = 18.8x|
  | 최대 loss      | 0.1845 (step 670)     | 0.4364 (step 20)      | v4 = 2.4x |
  | 최종 loss      | 0.0302                | 0.2245                | v4 = 7.4x |
  | loss 표준편차  | ~0.03 (추정)          | 0.0278                | 유사      |
  | NaN 발생       | -                     | 0                     | -         |

6-2. v4 loss가 높은 원인 분석

  v4의 loss가 v1 대비 3~7배 높지만, 이는 반드시 모델 성능 저하를 의미하지 않는다.
  v1과 v4의 loss는 직접 비교가 불가능하다. 그 이유:

  (1) 손실 함수 변경 (B2: Gray Consistency Loss)
      v4의 총 loss = L_diffusion + 0.1 * L_gray
      L_gray = MSE(ch0-ch1) + MSE(ch1-ch2)

      이 추가 항이 loss 값을 상승시킨다.
      v1에는 이 항이 없으므로 순수 diffusion loss만 보고됨.

  (2) Min-SNR 가중치 적용 (B3: snr_gamma=5.0)
      Min-SNR weighting은 노이즈가 많은 timestep에 더 높은 가중치를 부여한다.
      이로 인해 보고되는 loss 값이 증가하지만,
      실제로는 생성 품질이 개선되는 효과가 있다.
      (Hang et al., 2023 "Efficient Diffusion Training via Min-SNR Weighting Strategy")

  (3) 조기 종료 (B3: early_stopping_patience=20)
      v4는 24 에포크에서 조기 종료되었다.
      이는 검증 메트릭이 20 에포크 연속 개선되지 않아 종료된 것이다.
      v1은 100 에포크 전체를 완주하여 더 낮은 loss에 수렴했으나,
      이것이 반드시 더 나은 생성 품질을 의미하지는 않는다
      (과적합 가능성).

  (4) 데이터 증강 (B3: --augment)
      학습 시 horizontal flip(50%), brightness/contrast jitter(0.9~1.1)가
      적용되어 학습 데이터의 변동성이 증가한다.
      이는 loss 값을 높이지만 일반화 능력을 향상시킨다.

6-3. 핵심 판단

  v4의 높은 loss가 문제인지 여부는 loss 수치가 아니라 생성 품질로 판단해야 한다:

  - Phase 3 품질 점수 0.6633 → PASS (임계값 충족)
  - 아티팩트 점수 0.0 → v1에서 문제였던 RGB 아티팩트 해소
  - 선명도 1.0 → 흐림 문제 없음
  - 4개 클래스 전체에서 생성 성공

  따라서 v4의 loss 수치 상승은 손실 함수 변경에 의한 자연스러운 결과이며,
  생성 품질 관점에서는 v4가 v1 대비 개선되었다고 판단할 수 있다.
  (단, 정량적 이미지 유사도 비교(SSIM, FID)를 통한 객관적 검증이 필요)


7. 미해결 문제 및 권장 사항
================================================================================

7-1. 즉시 조치 필요

  (1) hint 경로 해석 버그 수정
      - 수정 A: _resolve_hint_path()에 data_dir.parent 기준 해석 추가
      - 수정 B: create_train_jsonl()의 base_dir를 output_dir로 변경
      - 상세: docs/20260219_1.docs 섹션 3 참조
      - 상태: 미적용, 미커밋

  (2) Phase 1 공식 실행
      - 현재 Phase 1이 미실행 상태
      - hint 경로 수정 후 재학습 → 전체 4단계 검증 재실행 필요

7-2. 품질 평가 개선

  (3) 품질 메트릭 보강
      현재 3개 메트릭(색상 일관성, 아티팩트, 선명도)만으로는 변별력 부족.
      추가 권장 메트릭:
      - SSIM (Structural Similarity Index): 구조적 유사도
      - LPIPS (Learned Perceptual Image Patch Similarity): 지각적 유사도
      - FID (Frechet Inception Distance): 분포 수준의 품질

  (4) Phase 2 정량적 평가
      파라미터 스윕 결과에 대해서도 정량적 메트릭을 산출하여
      최적 파라미터 조합을 객관적으로 결정해야 함

7-3. 데이터 전략

  (5) 클래스 불균형 대응
      Phase 1 생성 이미지 중 Class 3/4가 0개인 문제 해결 필요.
      증강 생성 시 클래스별 오버샘플링 전략 적용:
      - Class 3/4 ROI에 대해 더 많은 생성 요청
      - 또는 seed 변경을 통한 다양성 확보

  (6) v1 vs v4 생성 이미지 직접 비교
      동일 ROI에 대해 v1, v4 모델의 생성 결과를 나란히 비교하여
      grayscale 개선 효과를 시각적/정량적으로 검증


8. 다음 작업
================================================================================

  우선순위 순:

  (1) hint 경로 수정 적용 (수정 A + 수정 B) → git commit
  (2) Colab에서 v4 학습 재실행 (수정된 코드 기반)
  (3) 전체 4단계 검증 재실행 (Phase 1 포함)
  (4) Phase 3 품질 메트릭 보강 (SSIM, LPIPS 추가)
  (5) RGB 아티팩트 해소 여부 최종 확인
  (6) 품질 검증 통과 시 → 5,000매 합성 이미지 생성
  (7) 벤치마크 실험 준비 (docs/experiment.md 섹션 5 계획에 따라)


9. 파일 참조
================================================================================

  분석 대상:
    outputs/test_results_v4/test_results_v4/validation_results.json
    outputs/test_results_v4/test_results_v4/phase1_basic/generated/     (250개)
    outputs/test_results_v4/test_results_v4/phase1_basic/comparisons/   (250개)
    outputs/test_results_v4/test_results_v4/phase2_summary.json
    outputs/test_results_v4/test_results_v4/phase3_unseen/generation_summary.json
    outputs/test_results_v4/test_results_v4/phase3_unseen/unseen_test.jsonl
    outputs/test_results_v4/test_results_v4/phase4_report/training_stats.json
    outputs/test_results_v4/test_results_v4/phase4_report/validation_report.txt

  비교 대상 (v1):
    controlnet_training/training_log.json     (1,200 steps, 100 epochs)
    controlnet_training/training_config.json

  관련 문서:
    docs/20260219_1.docs    (hint 경로 버그 분석 + 6개 개선 방안)
    docs/20260219.docs      (엣지 결함 필터 + 이모지 수정)
    docs/experiment.md      (벤치마크 실험 설계)
